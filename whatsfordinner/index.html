<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>晚餐吃什麼?></title>
  </head>
  <body style="margin: 0">
    <div style="display: flex">
      <div id="map" style="width: 50%; height: 100vh"></div>
      <div style="padding: 20px">
        <input id="search-input" />
      </div>
    </div>
    <script>
      let map;
      let currentPosition;
      let selectedPlace;
      //標記物件
      let marker;
      //路線資訊
      let directionsService;
      //路線顯示
      let directionsRenderer;
      let infoWindow;
      //初始化地圖
      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          //包含經度緯度的物件
          center: { lat: 25.033964, lng: 121.564472 },
          //放大倍率
          zoom: 7,
        });
      }
      //取得使用者位置
      navigator.geolocation.getCurrentPosition(function (position) {
        currentPosition = {
          lat: position.coords.latitude,
          lng: position.coords.longitude,
        };
        //將地圖中心設定為使用者位置
        map.setCenter(currentPosition);
        map.setZoom(15);

        const autocomplete = new google.maps.places.Autocomplete(
          document.getElementById("search-input"),
          {
            types: ["restaurant"],
            bounds: {
              east: currentPosition.lng + 0.001,
              west: currentPosition.lng - 0.001,
              north: currentPosition.lat + 0.001,
              south: currentPosition.lat - 0.001,
            },
            strictBounds: false,
          }
        );
        //當使用者選擇地點時，將地圖中心設定為該地點
        autocomplete.addListener("place_changed", function () {
          //取得使用者選擇的地點
          const place = autocomplete.getPlace();

          selectedPlace = {
            location: place.geometry.location,
            destinationId: place.place_id,
            name: place.name,
            address: place.formatted_address,
            phoneNumber: place.formatted_phone_number,
            rating: place.rating,
          };
          console.log(selectedPlace);
          map.setCenter(selectedPlace.location);

          //在地圖上標記使用者位置
          if (!marker) {
            marker = new google.maps.Marker({
              map: map,
            });
          }

          marker.setPosition(selectedPlace.location);

          //路線資訊
          if (!directionsService) {
            directionsService = new google.maps.DirectionsService();
          }

          if (!directionsRenderer) {
            directionsRenderer = new google.maps.DirectionsRenderer({
              map: map,
            });
          }

          directionsRenderer.set("directions", null);

          directionsService.route(
            {
              origin: new google.maps.LatLng(
                currentPosition.lat,
                currentPosition.lng
              ),
              destination: {
                placeId: selectedPlace.destinationId,
              },
              //交通方式
              travelMode: "DRIVING",
            },
            function (response, status) {
              if (status === "OK") {
                directionsRenderer.setDirections(response);

                if (!infoWindow) {
                  infoWindow = new google.maps.InfoWindow();
                }

                infoWindow.setContent(
                  `
                  <h2>${selectedPlace.name}</h2>
                  <div>地址: ${selectedPlace.address}</div>
                  <div>電話: ${selectedPlace.phoneNumber}</div>
                  <div>評分: ${selectedPlace.rating}</div>
                  <div>步行時間: ${response.routes[0].legs[0].duration.text}</div>
                `
                );
                infoWindow.open(map, marker);
              }
            }
          );
        });
      });
    </script>
    <script
      async
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB2uczgCERxcw56GfUJIKWnvuAnWuHTUb4&libraries=places&callback=initMap&region=TW&language=zh-TW"
    ></script>
  </body>
</html>
